name: Release Build

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  publish-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            args: "--target aarch64-apple-darwin"

          - platform: macos-latest
            target: x86_64-apple-darwin
            args: "--target x86_64-apple-darwin"

          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            args: ""

          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            args: ""

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt update
          sudo apt install -y \
            libwebkit2gtk-4.0-dev \
            libgtk-3-dev \
            libssl-dev \
            build-essential \
            curl wget file patchelf

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download binaries (Windows with Bash)
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          chmod +x scripts/download-binaries.sh
          ./scripts/download-binaries.sh
        env:
          TARGET_ARCH: ${{ matrix.target }}

      - name: Download binaries (macOS/Linux)
        if: matrix.platform != 'windows-latest'
        run: |
          chmod +x scripts/download-binaries.sh
          ./scripts/download-binaries.sh
        env:
          TARGET_ARCH: ${{ matrix.target }}

      - name: Verify FFmpeg
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "windows-latest" ]; then
            FFMPEG_BIN="src-tauri/binaries/ffmpeg-${{ matrix.target }}.exe"
          else
            FFMPEG_BIN="src-tauri/binaries/ffmpeg-${{ matrix.target }}"
          fi

          if [ ! -f "$FFMPEG_BIN" ]; then
            echo "❌ FFmpeg missing: $FFMPEG_BIN"
            echo "Listing binaries directory:"
            ls -R src-tauri/binaries || true
            exit 1
          fi

          echo "✅ FFmpeg found: $FFMPEG_BIN"
          ls -lh "$FFMPEG_BIN"

      - name: Install backend dependencies (non-Windows)
        if: matrix.platform != 'windows-latest'
        shell: bash
        run: |
          PYTHON_BIN="./src-tauri/binaries/python-${{ matrix.target }}/bin/python3"

          if [ ! -f "$PYTHON_BIN" ]; then
            echo "❌ Bundled Python missing: $PYTHON_BIN"
            echo "Listing binaries directory:"
            ls -R src-tauri/binaries || true
            exit 1
          fi

          echo "✅ Python found: $PYTHON_BIN"
          "$PYTHON_BIN" --version

          "$PYTHON_BIN" -m pip install --upgrade pip
          "$PYTHON_BIN" -m pip install -r requirements.txt

          echo "✅ Python dependencies installed"

      - name: Locate and install Python (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "=== Locating bundled Python ==="

          # Try explicit path first
          $pythonPath = "src-tauri\binaries\python-${{ matrix.target }}\python.exe"

          if (Test-Path $pythonPath) {
            Write-Host "✅ Found Python at explicit path: $pythonPath"
            $pythonBin = (Resolve-Path $pythonPath).Path
          } else {
            Write-Host "⚠️ Explicit path not found, searching..."
            $found = Get-ChildItem -Path "src-tauri\binaries" -Recurse -Filter "python.exe" -ErrorAction SilentlyContinue | 
                     Where-Object { $_.FullName -notlike "*\DLLs\*" -and $_.FullName -notlike "*\Scripts\*" } | 
                     Select-Object -First 1
            
            if ($null -eq $found) {
              Write-Host "❌ No python.exe found!"
              Write-Host "Listing binaries directory:"
              Get-ChildItem -Path "src-tauri\binaries" -Recurse | Format-Table Name, FullName
              exit 1
            }
            
            $pythonBin = $found.FullName
          }

          Write-Host "✅ Using Python: $pythonBin"
          & $pythonBin --version

          # Set environment variable for next steps
          "PYTHON_BIN=$pythonBin" >> $env:GITHUB_ENV

          # Install dependencies
          Write-Host "=== Installing Python dependencies ==="
          & $pythonBin -m pip install --upgrade pip
          & $pythonBin -m pip install -r requirements.txt
          Write-Host "✅ Python dependencies installed"

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Tauri
        run: |
          npm --prefix frontend run tauri build -- ${{ matrix.args }}

      # ---------------------------
      # macOS rename
      # ---------------------------
      - name: Rename macOS outputs
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          set -e

          # Get version from tag or use default
          if [ -n "$GITHUB_REF_NAME" ] && [[ "$GITHUB_REF_NAME" == v* ]]; then
            VERSION=${GITHUB_REF_NAME#v}
          else
            VERSION="1.0.0"
          fi

          echo "Using version: $VERSION"

          # Use predictable Tauri output path
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle/dmg"

          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "❌ Bundle directory not found: $BUNDLE_DIR"
            echo "Listing target directory:"
            find src-tauri/target -type d -name "bundle" || true
            exit 1
          fi

          DMG=$(find "$BUNDLE_DIR" -type f -name "*.dmg" -print -quit)

          if [ -z "$DMG" ]; then
            echo "❌ No DMG file found in $BUNDLE_DIR"
            ls -lh "$BUNDLE_DIR" || true
            exit 1
          fi

          echo "Found DMG: $DMG"

          if [[ "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
            NEW_NAME="$BUNDLE_DIR/harmonixse_macos_${VERSION}_arm64.dmg"
          else
            NEW_NAME="$BUNDLE_DIR/harmonixse_macos_${VERSION}_x86_64.dmg"
          fi

          mv "$DMG" "$NEW_NAME"
          echo "✅ Renamed to: $NEW_NAME"
          ls -lh "$NEW_NAME"

      # ---------------------------
      # Linux rename
      # ---------------------------
      - name: Rename Linux outputs
        if: matrix.platform == 'ubuntu-22.04'
        shell: bash
        run: |
          set -e

          if [ -n "$GITHUB_REF_NAME" ] && [[ "$GITHUB_REF_NAME" == v* ]]; then
            VERSION=${GITHUB_REF_NAME#v}
          else
            VERSION="1.0.0"
          fi

          echo "Using version: $VERSION"

          # AppImage
          APPDIR="src-tauri/target/${{ matrix.target }}/release/bundle/appimage"
          if [ -d "$APPDIR" ]; then
            APP=$(find "$APPDIR" -type f -name "*.AppImage" -print -quit)
            if [ -n "$APP" ]; then
              NEW_APP="$APPDIR/harmonixse_linux_${VERSION}_x86_64.AppImage"
              mv "$APP" "$NEW_APP"
              echo "✅ Renamed AppImage: $NEW_APP"
              ls -lh "$NEW_APP"
            else
              echo "⚠️ No AppImage found in $APPDIR"
            fi
          else
            echo "⚠️ AppImage directory not found: $APPDIR"
          fi

          # DEB
          DEBDIR="src-tauri/target/${{ matrix.target }}/release/bundle/deb"
          if [ -d "$DEBDIR" ]; then
            DEB=$(find "$DEBDIR" -type f -name "*.deb" -print -quit)
            if [ -n "$DEB" ]; then
              NEW_DEB="$DEBDIR/harmonixse_linux_${VERSION}_x86_64.deb"
              mv "$DEB" "$NEW_DEB"
              echo "✅ Renamed DEB: $NEW_DEB"
              ls -lh "$NEW_DEB"
            else
              echo "⚠️ No DEB found in $DEBDIR"
            fi
          else
            echo "⚠️ DEB directory not found: $DEBDIR"
          fi

      # ---------------------------
      # Windows rename
      # ---------------------------
      - name: Rename Windows outputs
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          if ($env:GITHUB_REF_NAME -match "^v(.+)$") {
            $VERSION = $matches[1]
          } else {
            $VERSION = "1.0.0"
          }

          Write-Host "Using version: $VERSION"

          $targetDir = "src-tauri\target\${{ matrix.target }}\release\bundle"

          if (-not (Test-Path $targetDir)) {
            Write-Host "❌ Bundle directory not found: $targetDir"
            exit 1
          }

          # MSI
          $msiDir = Join-Path $targetDir "msi"
          if (Test-Path $msiDir) {
            $msi = Get-ChildItem $msiDir -Filter "*.msi" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($msi) {
              $newName = "harmonixse_windows_${VERSION}_x86_64.msi"
              $newPath = Join-Path $msiDir $newName
              Move-Item $msi.FullName $newPath -Force
              Write-Host "✅ Renamed MSI: $newPath"
            } else {
              Write-Host "⚠️ No MSI found in $msiDir"
            }
          }

          # NSIS Installer
          $nsisDir = Join-Path $targetDir "nsis"
          if (Test-Path $nsisDir) {
            $installer = Get-ChildItem $nsisDir -Filter "*_setup.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($installer) {
              $newName = "harmonixse_windows_${VERSION}_x86_64.exe"
              $newPath = Join-Path $nsisDir $newName
              Move-Item $installer.FullName $newPath -Force
              Write-Host "✅ Renamed installer: $newPath"
            }
            
            # Portable EXE
            $portable = Get-ChildItem $nsisDir -Filter "*_portable.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($portable) {
              $newName = "harmonixse_windows_${VERSION}_x86_64_portable.exe"
              $newPath = Join-Path $nsisDir $newName
              Move-Item $portable.FullName $newPath -Force
              Write-Host "✅ Renamed portable exe: $newPath"
            }
          }

          # ZIP
          $zipDir = Join-Path $targetDir "zip"
          if (Test-Path $zipDir) {
            $zip = Get-ChildItem $zipDir -Filter "*.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($zip) {
              $newName = "harmonixse_windows_${VERSION}_x86_64_portable.zip"
              $newPath = Join-Path $zipDir $newName
              Move-Item $zip.FullName $newPath -Force
              Write-Host "✅ Renamed zip: $newPath"
            }
          }

      # ---------------------------
      # Verify artifacts exist
      # ---------------------------
      - name: Verify artifacts
        shell: bash
        run: |
          echo "=== Verifying build artifacts ==="

          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            PATTERN="src-tauri/target/${{ matrix.target }}/release/bundle/dmg/harmonixse_macos_*.dmg"
          elif [ "${{ matrix.platform }}" = "ubuntu-22.04" ]; then
            PATTERN="src-tauri/target/${{ matrix.target }}/release/bundle/*/harmonixse_linux_*"
          else
            PATTERN="src-tauri/target/${{ matrix.target }}/release/bundle/*/harmonixse_windows_*"
          fi

          echo "Looking for artifacts matching: $PATTERN"

          if ls $PATTERN 1> /dev/null 2>&1; then
            echo "✅ Artifacts found:"
            ls -lh $PATTERN
          else
            echo "❌ No artifacts found matching pattern"
            echo "Listing bundle directory:"
            find src-tauri/target -name "bundle" -type d -exec ls -lR {} \; || true
            exit 1
          fi

      # ---------------------------
      # Upload
      # ---------------------------
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/**/bundle/**/harmonixse_macos_*_arm64.dmg
            src-tauri/target/**/bundle/**/harmonixse_macos_*_x86_64.dmg

            src-tauri/target/**/bundle/**/harmonixse_linux_*_x86_64.AppImage
            src-tauri/target/**/bundle/**/harmonixse_linux_*_x86_64.deb

            src-tauri/target/**/bundle/**/harmonixse_windows_*_x86_64.msi
            src-tauri/target/**/bundle/**/harmonixse_windows_*_x86_64.exe
            src-tauri/target/**/bundle/**/harmonixse_windows_*_x86_64_portable.exe
            src-tauri/target/**/bundle/**/harmonixse_windows_*_x86_64_portable.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
